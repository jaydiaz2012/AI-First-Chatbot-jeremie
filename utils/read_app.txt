 user_question = st.text_input("What's your route risk question?")

    if st.button("Submit"):
        if user_question:
            System_Prompt = """ 

Role:  
You are a transport route risk assessment assistant, designed specifically for logistics and order managers. Your purpose is to analyze and report on risks associated with transport routes, considering factors such as weather, traffic, security, and geopolitical stability. Your responses are both informational and actionable, helping users make informed routing decisions.

Instructions: Using the provided dataset of delivery and shipment records, analyze the data to answer specific questions and provide actionable insights. Evaluate shipment details and assess the risks for a specified route based on current conditions, past data, and route-specific factors like weather, traffic, security, and any regional instability.
- If a high-risk area is detected, provide alternative route options that may be safer or more efficient, if possible.
- Inform users of emerging risks, such as sudden weather changes or security threats, that could impact their current or planned routes. Answer queries related to the shipment data. 
- Your responses should be well-structured, based on data analysis, and aimed at improving decision-making for risk assessment.

Context:
- You are navigating a dataset with columns that capture the following data points:
    category_id: classifying the category
    category_name: naming the category
    customer_city: city where the delivery comes from 
    customer_country: country where the delivery comes from 
    customer_id: classifying the customer 
    order_city: city where the delivery goes to
    order_country: country where the delivery goes to 
    order_customer_id: classifying the customer's order
    order_date: date when the order will be delivered
    order_id: classifying the order
    sales: amount of purchase 
    product_name: brand of the ordered product
    product_price: price of the ordered product
    shipping_date: when the order will be transported
    shipping_mode: what type of transportation for the delivery of ordered product  

Constraints:
- Only use the provided dataset for your analysis.
- Ensure your responses are based on the data, without making assumptions outside the dataset.
- Only provide route-specific information, avoiding extraneous details that don’t impact the selected routes.
- Ensure explanations are concise and clear; use plain language for easy comprehension.
- Limit risk categories to core areas: Weather Hazards, Traffic, Security Risks, and Political Instability.

Communication:  
- Use a polite, professional, and straightforward tone.
- When prompting users, ask for relevant details like origin, destination, and cargo type to provide accurate assessments.
- Use clear, direct language for high-risk notifications, prioritizing user safety and quick response.

Evaluation  
- Ensure risk assessments are based on the dataset.
- Regularly incorporate user feedback to improve risk scoring and route recommendations.
- Aim to respond in near real-time, especially for time-sensitive risk alerts. 

Example
Example 1: User 1: Hi, I need a risk assessment for a transport route. We’ll be moving cargo from New York to Chicago tomorrow, with a delivery deadline of 6 PM. The cargo is fragile and sensitive to temperature changes. Can you let me know about any risks on this route and if there are safer alternatives if risks are high? Also, please keep me updated with any real-time alerts during the journey.
Example 2: User 2: Hi, I’m planning a shipment from Caguas to Los Angeles City with valuable electronics. Given recent reports of theft along this route, could you evaluate security risks? If there are high-risk areas, please recommend alternative routes or any precautionary measures. I’d also like updates if new risks appear during the transport.
Example 3: User 3: Hi, I’m planning a transport route from West New York to Sousa next week for a high-value electronics shipment. Could you provide a risk overview for that route and let me know of any potential concerns or higher-risk areas? I’d also like to be alerted if any new risks come up closer to the shipping date.

"""
#            struct = [{'role': 'system', 'content': System_Prompt}]
#            struct.append({"role": "user", "content": user_question})
#    
#            try:
#                chat = openai.ChatCompletion.create(model="gpt-4o-mini", messages=struct)
#                response = chat.choices[0].message.content
#                st.success("Here's what RouteX says:")
#                st.write(response)
#            except Exception as e:
#                st.error(f"An error occurred while getting the response: {str(e)}")
#        else:
#            st.warning("Please enter a question before submitting!")


if openai.api_key and (openai.api_key.startswith('sk-') and len(openai.api_key) == 164):
    st.title("RouteX: Risk Assessor Assistant")
    
    origin = st.text_input("Enter the source location of delivery (city):")
    destination = st.text_input("Enter the destination location (city):")
    item_type = st.selectbox("Select the risk:", ["weather hazards", "security risks", "traffic", "political instability"])
    
    if st.button("Get Risk Assessment"):
        # Load the dataset and create embeddings only when the button is pressed
        dataframed = pd.read_csv('https://raw.githubusercontent.com/jaydiaz2012/AI-First-Chatbot-jeremie/refs/heads/main/delivery_logistics1_final.csv')
        dataframed['combined'] = dataframed.apply(lambda row: ' '.join(row.values.astype(str)), axis=1)
        documents = dataframed['combined'].tolist()

        # Generate embeddings for the documents
        embeddings = [get_embedding(doc, engine="text-embedding-3-small") for doc in documents]
        embedding_dim = len(embeddings[0])
        embeddings_np = np.array(embeddings).astype('float32')

        # Create a FAISS index for efficient similarity search
        index = faiss.IndexFlatL2(embedding_dim)
        index.add(embeddings_np)

        user_message = f"Hello, I need a quick risk assessment for a delivery from {origin} to {destination}. The cargo is important, so {item_type} could be a problem. Could you assess potential risks and suggest alternative routes if necessary?"
        # Generate embedding for the user message
        query_embedding = get_embedding(user_message, engine='text-embedding-3-small')
        query_embedding_np = np.array([query_embedding]).astype('float32')

        # Search for similar documents
        _, indices = index.search(query_embedding_np, 2)
        retrieved_docs = [documents[i] for i in indices[0]]
        context = ' '.join(retrieved_docs)

        # Prepare structured prompt
        structured_prompt = f"Context:\n{context}\n\nQuery:\n{user_message}\n\nResponse:"

        # Call OpenAI API
        chat = openai.ChatCompletion.create(
            model="gpt-4o-mini",
            messages=[{"role": "system", "content": System_Prompt}] + [{"role": "user", "content": structured_prompt}],
            temperature=0.5,
            max_tokens=1500,
            top_p=1,
            frequency_penalty=0,
            presence_penalty=0
        )
        
        # Get response
        response = chat.choices[0].message.content
        st.session_state.messages.append({"role": "assistant", "content": response})

        # Display the response
        st.write(response)

    # Follow-up question input
    if st.session_state.messages:
        follow_up_question = st.text_input("Ask a follow-up question:")
        if st.button("Submit Follow-Up"):
            # Append the user's follow-up question to the messages
            st.session_state.messages.append({"role": "user", "content": follow_up_question})

            # Prepare the structured prompt for the follow-up question
            follow_up_context = ' '.join([msg['content'] for msg in st.session_state.messages if msg['role'] == 'assistant'])
            follow_up_prompt = f"Context:\n{follow_up_context}\n\nQuery:\n{follow_up_question}\n\nResponse:"

            # Call OpenAI API for the follow-up question
            follow_up_chat = openai.ChatCompletion.create(
                model="gpt-4o-mini",
                messages=[{"role": "system", "content": System_Prompt}] + [{"role": "user", "content": follow_up_prompt}],
                temperature=0.5,
                max_tokens=1500,
                top_p=1,
                frequency_penalty=0,
                presence_penalty=0
            )

            # Get response for the follow-up question
            follow_up_response = follow_up_chat.choices[0].message.content
            st.session_state.messages.append({"role": "assistant", "content": follow_up_response})

            # Display the follow-up response
            st.write(follow_up_response)
else:
    st.warning("Please enter your OpenAI API key to use the chatbot.")
